SELECT /*+ PARALLEL(8) */
       m.iin,
       ROUND(SUM(m.month_amount))                    AS percent_sum,
       COUNT(*)                                      AS cnt_mnth,
       ROUND(SUM(m.month_amount) / NULLIF(COUNT(*),0)) AS amount_month
FROM (
    -- Сгруппировать по iin + месяцу: даёт одну строку на iin+month
    SELECT
        NVL(g.iin_bin, 'UNKNOWN') AS iin,
        TRUNC(ha.exec_date, 'MM')  AS mnth,
        SUM(ha.amount_sum_nat)     AS month_amount
    FROM dds.RS_DS_ANL_HALFENTRY_FL    ha
    JOIN dds.RS_PD_PAYMENT_FL         pd
      ON ha.RS_DS_OPER_SOURCE_ID = pd.PARENT_PROCESSID
     AND ha.RS_DS_OPER_NJRN       = pd.PARENT_PROCESS_NJRN
    LEFT JOIN dds.gm_subject_h       g
      ON g.dwh_id = ha.gm_subject_id
     AND g.gm_system_code = 'RS'
    JOIN dds.rs_ds_contract_scd_s    ds
      ON ha.rs_ds_contract_id = ds.dwh_id
     AND ds.is_actual = 'A'
    JOIN dds.rs_gm_product_h        pr
      ON ds.rs_gm_product_id = pr.dwh_id
    WHERE ha.DATE_VALUE >= DATE '2025-12-01'
      AND ha.DATE_VALUE <  DATE '2025-12-10'
      AND pd.DATE_VALUE >= DATE '2025-12-01'
      AND pd.DATE_VALUE <  DATE '2025-12-10'
      AND ha.INCOM_FL = 0
      AND ha.NORD    = 1
      AND LOWER(ha.ASSIGN) LIKE '%выплата%'
      AND (ds.close_date = ds.end_date OR ds.close_date IS NULL)
    GROUP BY NVL(g.iin_bin,'UNKNOWN'), TRUNC(ha.exec_date,'MM')
) m
GROUP BY m.iin;