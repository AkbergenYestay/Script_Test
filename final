import datetime
import subprocess
import pandas as pd

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.oracle.hooks.oracle import OracleHook
from airflow.utils.email import send_email
from airflow.models import Variable


DAG_ID = "pfm_acc_dep_openway_monitoring"


default_args = {
    "owner": "Yestay",
    "email": [
        "AlmasA@halykbank.kz",
        "EstayA@halykbank.kz",
        "QuanysQo@halykbank.kz",
        "AIYGERIMIB@halykbank.kz",
        "DaniyarMussa@halykbank.kz",
    ],
    "email_on_failure": True,
    "depends_on_past": False,
}


def check_send_and_pause():
    today = datetime.date.today().isoformat()
    now = datetime.datetime.now()

    print(f"[INFO] DAG run at {now}")

    oracle_hook = OracleHook(
        oracle_conn_id="db_oracle_ipc__edw_ipc",
        thick_mode=True,
    )

    sql = """
WITH need AS (
    SELECT 'wf_PROD_edw_to_operations_account' wf FROM dual UNION ALL
    SELECT 'wf_PROD_edw_to_operations_deposit' FROM dual UNION ALL
    SELECT 'wf_PROD_edw_to_operations_openway' FROM dual
),
last_wf_run AS (
    SELECT
        r.workflow_id,
        r.workflow_name,
        r.workflow_run_id,
        r.start_time AS wf_start_time,
        r.end_time   AS wf_end_time,
        r.run_err_code,
        ROW_NUMBER() OVER (PARTITION BY r.workflow_id ORDER BY r.start_time DESC) rn
    FROM RB_REP.OPB_WFLOW_RUN r
    WHERE trunc(r.start_time) = trunc(sysdate)
),
ins_rows AS (
    SELECT
        s.workflow_run_id,
        MAX(s.affected_rows) AS inserted_rows
    FROM RB_REP.OPB_SWIDGINST_LOG s
    GROUP BY s.workflow_run_id
)
SELECT
    n.wf AS workflow_name,
    w.workflow_run_id,
    w.wf_start_time,
    w.wf_end_time,
    CASE
        WHEN w.workflow_run_id IS NULL THEN 'NOT STARTED'
        WHEN w.wf_end_time IS NULL THEN 'RUNNING'
        WHEN NVL(w.run_err_code,0) <> 0 THEN 'ERROR/WARNING'
        ELSE 'SUCCESS'
    END AS wf_status,
    NVL(ir.inserted_rows, 0) AS inserted_rows
FROM need n
LEFT JOIN last_wf_run w
    ON w.workflow_name = n.wf AND w.rn = 1
LEFT JOIN ins_rows ir
    ON ir.workflow_run_id = w.workflow_run_id
ORDER BY n.wf
"""

    conn = oracle_hook.get_conn()
    with conn.cursor() as cursor:
        cursor.execute(sql)
        rows = cursor.fetchall()
        cols = [c[0] for c in cursor.description]
    conn.close()

    df = pd.DataFrame(rows, columns=cols)
    print(f"[INFO] Rows fetched: {len(df)}")

    if df.empty:
        print("[INFO] No data yet")
        return

    not_finished = df[
        df["WORKFLOW_RUN_ID"].isna()
        | df["WF_END_TIME"].isna()
    ]

    if not not_finished.empty:
        print("[INFO] Workflows still running ‚Äî continue waiting")
        return

    print("[INFO] All workflows finished ‚Äî sending email")

    lines = [f"<b>–î–∞—Ç–∞:</b> {today}<br><br>"]
    for _, r in df.iterrows():
        lines.append(
            f"<b>{r['WORKFLOW_NAME']}</b><br>"
            f"–°—Ç–∞—Ä—Ç: {r['WF_START_TIME']}<br>"
            f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: {r['WF_END_TIME']}<br>"
            f"–°—Ç–∞—Ç—É—Å: {r['WF_STATUS']}<br>"
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {int(r['INSERTED_ROWS'])}<br><br>"
        )

    send_email(
        to=default_args["email"],
        subject="PFM acc / dep / openway ‚Äî —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–æ–∫",
        html_content="".join(lines),
    )

    print("[INFO] Email sent ‚Äî pausing DAG")

    # üî¥ SELF-PAUSE
    subprocess.run(
        ["airflow", "dags", "pause", DAG_ID],
        check=True,
    )


with DAG(
    dag_id=DAG_ID,
    default_args=default_args,
    start_date=datetime.datetime(2025, 1, 1),
    schedule="*/15 8-23 * * *",
    catchup=False,
    tags=["pfm"],
) as dag:

    monitor_and_pause = PythonOperator(
        task_id="check_send_and_pause",
        python_callable=check_send_and_pause,
    )

    monitor_and_pause