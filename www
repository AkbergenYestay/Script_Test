WITH params AS (
  SELECT DATE '2025-01-01' AS start_dt,
         TRUNC(SYSDATE, 'MM') AS end_dt
  FROM dual
),
raw AS (
  SELECT
    ha.iin_bin                       AS iin,
    TRUNC(ha.exec_date, 'MM')        AS mnth,
    ha.amount_sum_nat                AS amt
  FROM dds.RS_DS_ANL_HALFENTRY_FL ha
  JOIN dds.RS_PD_PAYMENT_FL pd
    ON ha.RS_DS_OPER_SOURCE_ID = pd.PARENT_PROCESSID
   AND ha.RS_DS_OPER_NJRN       = pd.PARENT_PROCESS_NJRN
  LEFT JOIN dds.GM_SUBJECT_H g
    ON g.DWH_ID = ha.GM_SUBJECT_ID
   AND g.GM_SYSTEM_CODE = 'RS'
  JOIN dds.RS_DS_CONTRACT_SCD_S ds
    ON ha.RS_DS_CONTRACT_ID = ds.DWH_ID
   AND ds.IS_ACTUAL = 'A'
  JOIN dds.RS_GM_PRODUCT_H pr
    ON ds.RS_GM_PRODUCT_ID = pr.DWH_ID
  WHERE ha.DATE_VALUE >= (SELECT start_dt FROM params)
    AND ha.DATE_VALUE <  (SELECT end_dt FROM params)
    AND pd.DATE_VALUE >= (SELECT start_dt FROM params)
    AND pd.DATE_VALUE <  (SELECT end_dt FROM params)
    AND ha.INCOM_FL = 0
    AND ha.NORD = 1
    AND LOWER(ha.ASSIGN) LIKE '%выплата%'
    AND (ds.CLOSE_DATE = ds.END_DATE OR ds.CLOSE_DATE IS NULL)
),
agg AS (
  SELECT
    iin,
    COUNT(DISTINCT mnth)                     AS cnt_mnth,
    ROUND(SUM(amt))                          AS percent_sum,
    ROUND(SUM(amt) / NULLIF(COUNT(DISTINCT mnth), 0)) AS amount_month
  FROM raw
  GROUP BY iin
)
SELECT /*+ parallel(8) */
  a.iin,
  a.percent_sum,
  a.cnt_mnth,
  a.amount_month,
  'depo_itog_proc' AS product_code,
  TRUNC(SYSDATE)     AS upload_date,
  JSON_OBJECT(
    'en' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE a.percent_sum)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE a.amount_month))
    ),
    'kk' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE a.percent_sum)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE a.amount_month))
    ),
    'ru' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE a.percent_sum)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE a.amount_month))
    )
  ) AS payload
FROM agg a;