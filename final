import datetime
import pandas as pd

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.oracle.hooks.oracle import OracleHook
from airflow.utils.email import send_email
from airflow.models import Variable


default_args = {
    "owner": "Yestay",
    "email": [
        "AlmasA@halykbank.kz",
        "EstayA@halykbank.kz",
        "QuanysQo@halykbank.kz",
        "AIYGERIMIB@halykbank.kz",
        "DaniyarMussa@halykbank.kz",
    ],
    "email_on_failure": True,
    "depends_on_past": False,
}


def check_and_send_email():
    today = datetime.date.today().isoformat()

    last_sent = Variable.get(
        "pfm_acc_dep_openway_email_sent",
        default_var="1970-01-01",
    )

    if last_sent == today:
        return

    oracle_hook = OracleHook(
        oracle_conn_id="db_oracle_ipc__edw_ipc",
        thick_mode=True,
    )

    sql = """
WITH need AS (
    SELECT 'wf_PROD_edw_to_operations_account'  wf, 's_m_PROD_account_edw_to_operations'  task FROM dual UNION ALL
    SELECT 'wf_PROD_edw_to_operations_deposit', 's_m_PROD_deposit_edw_to_operations'       FROM dual UNION ALL
    SELECT 'wf_PROD_edw_to_operations_openway', 's_m_PROD_openway_edw_to_operations'       FROM dual
),
last_wf_run AS (
    SELECT
        r.workflow_id,
        r.workflow_name,
        r.workflow_run_id,
        r.start_time wf_start_time,
        r.end_time   wf_end_time,
        r.run_err_code,
        ROW_NUMBER() OVER (PARTITION BY r.workflow_id ORDER BY r.start_time DESC) rn
    FROM RB_REP.OPB_WFLOW_RUN r
    WHERE trunc(r.start_time) = trunc(sysdate)
)
SELECT
    n.wf                     AS workflow_name,
    w.wf_start_time,
    w.wf_end_time,
    CASE
        WHEN w.workflow_run_id IS NULL THEN 'NOT STARTED'
        WHEN w.wf_end_time IS NULL THEN 'RUNNING'
        WHEN NVL(w.run_err_code,0) <> 0 THEN 'ERROR/WARNING'
        ELSE 'SUCCESS'
    END AS wf_status,
    NVL(t.affected_rows, 0)  AS affected_rows,
    t.end_time               AS task_end_time
FROM need n
LEFT JOIN last_wf_run w
    ON w.workflow_name = n.wf
   AND w.rn = 1
LEFT JOIN RB_REP.OPB_TASK_INST_RUN t
    ON t.workflow_run_id = w.workflow_run_id
   AND t.task_name = n.task
   AND t.task_type = 68
ORDER BY n.wf
"""

    conn = oracle_hook.get_conn()
    with conn.cursor() as cursor:
        cursor.execute(sql)
        rows = cursor.fetchall()
        cols = [c[0] for c in cursor.description]
    conn.close()

    df = pd.DataFrame(rows, columns=cols)

    if df.empty:
        return

    not_finished = df[
        df["WF_START_TIME"].isna()
        | df["WF_END_TIME"].isna()
        | df["TASK_END_TIME"].isna()
    ]

    if not not_finished.empty:
        return

    lines = [f"<b>Дата:</b> {today}<br><br>"]

    for _, r in df.iterrows():
        lines.append(
            f"<b>{r['WORKFLOW_NAME']}</b><br>"
            f"Старт: {r['WF_START_TIME']}<br>"
            f"Завершение: {r['WF_END_TIME']}<br>"
            f"Статус: {r['WF_STATUS']}<br>"
            f"Количество записей: {int(r['AFFECTED_ROWS'])}<br><br>"
        )

    send_email(
        to=default_args["email"],
        subject="PFM acc / dep / openway — статус загрузок",
        html_content="".join(lines),
    )

    Variable.set("pfm_acc_dep_openway_email_sent", today)


with DAG(
    dag_id="pfm_acc_dep_openway_monitoring",
    default_args=default_args,
    start_date=datetime.datetime(2025, 1, 1),
    schedule="*/15 8-23 * * *",
    catchup=False,
    tags=["pfm"],
) as dag:

    check_and_send = PythonOperator(
        task_id="check_and_send_email",
        python_callable=check_and_send_email,
    )

    check_and_send