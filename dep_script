Select 'COLVIR_DEPO'                               as SYSTEM,
       ff.gm_currency_id                              DDEPO_CURRENCY,
       exec_date                                      DDEPO_FROMDATE,
       sdok_sum                                       oper_sum,
       sdok_sum_nat                                   oper_sum_nat,
       nvl(pd.refer, cash.refer) 		      refer,
       ff.source_id                                   trn_id,
       to_char(AC.ACCOUNT_NUMBER)                     id,
       case when ff.INCOM_FL = 1 then 0 else 1 end as DOHOD,
       nvl(ff.dscr, ff.doc)                        as "operation_name",
       g.iin_bin                                   as IIN,
       g.longname                                     NAME,
       dot.LONGNAME,
       sot.LONGNAME,
       pot.LONGNAME
from dds.RS_GL_HALFENTRY_FL ff
         inner join dds.gl_account_h ac on ac.dwh_id = ff.gl_account_id and ac.gm_system_code = 'RS'
         inner join dds.gm_subject_h g on g.dwh_id = ff.gm_subject_id and g.gm_system_code = 'RS'
         left join dds.RS_PD_PAYMENT_FL pd on pd.source_id = ff.ord_id and pd.date_value = to_date('31.07.2025', 'dd.mm.yyyy')
         left join dds.RS_PD_ORDCASH_FL cash on cash.SOURCE_ID = ff.ORD_ID and cash.DATE_VALUE = to_date('31.07.2025', 'dd.mm.yyyy')
         left join (select RS_GL_HALFENTRY_SOURCE_ID, RS_GL_HALFENTRY_INCOM_FL, RS_GL_HALFENTRY_NORD, RS_GM_OPERTYPE_ID
                    from (select row_number() over (partition by l.RS_GL_HALFENTRY_SOURCE_ID, l.RS_GL_HALFENTRY_INCOM_FL, l.RS_GL_HALFENTRY_NORD order by o.OPER_DATE desc) rnk,
                                    l.RS_GL_HALFENTRY_SOURCE_ID,
                                    l.RS_GL_HALFENTRY_INCOM_FL,
                                    l.RS_GL_HALFENTRY_NORD,
                                    o.RS_GM_OPERTYPE_ID
                             from dds.RS_DS_HALFENTRY_OPER_L l,
                                  dds.RS_DS_OPER_FL o
                             where l.DATE_VALUE = to_date('31.07.2025', 'dd.mm.yyyy')
                               and o.DATE_VALUE = to_date('31.07.2025', 'dd.mm.yyyy')
                               and o.SOURCE_ID = l.RS_DS_OPER_SOURCE_ID
                               and o.NJRN = l.RS_DS_OPER_NJRN)
                    where rnk = 1) oper
                   on oper.RS_GL_HALFENTRY_SOURCE_ID = ff.SOURCE_ID and oper.RS_GL_HALFENTRY_INCOM_FL = ff.INCOM_FL and oper.RS_GL_HALFENTRY_NORD = ff.NORD
         left join dds.RS_GM_OPERTYPE_H dot on dot.DWH_ID = oper.RS_GM_OPERTYPE_ID
         left join dds.RS_GM_OPERTYPE_H sot on sot.DWH_CODE = cash.PD_OPRCHR_CODE
         left join dds.RS_GM_OPERTYPE_H pot on pot.DWH_ID = pd.RS_GM_OPERTYPE_ID
where ff.DATE_VALUE = to_date('31.07.2025', 'dd.mm.yyyy')
  --and ff.GM_SUBJECT_ID = 85959116
  --and ff.GL_ACCOUNT_ID = 172530348
  and exists(
        select 1
        from dds.RS_DS_CONTRACT_H ds,
             dds.RS_DS_CONTRACT_ACCOUNT_L l
        where ds.DWH_ID = l.RS_DS_CONTRACT_ID
          and l.GL_ACCOUNT_ID = ff.GL_ACCOUNT_ID
          and l.IS_ACTUAL = 'A')
