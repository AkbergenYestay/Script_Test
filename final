WITH last_run AS (
    SELECT
        r.workflow_id,
        r.workflow_run_id,
        r.start_time,
        r.end_time,
        r.run_err_code,
        ROW_NUMBER() OVER (
            PARTITION BY r.workflow_id
            ORDER BY r.start_time DESC
        ) rn
    FROM RB_REP.OPB_WFLOW_RUN r
    WHERE TRUNC(r.start_time) = TRUNC(SYSDATE)
),
wf_today AS (
    SELECT
        wf.workflow_id,
        wf.workflow_name,
        wf.scheduler_id,
        lr.workflow_run_id,
        lr.start_time AS run_start_time,
        lr.end_time   AS run_end_time,
        lr.run_err_code
    FROM RB_REP.OPB_WORKFLOW wf
    LEFT JOIN last_run lr
        ON lr.workflow_id = wf.workflow_id
       AND lr.rn = 1
)
SELECT
    t.workflow_name                                       AS workflow_name,
    t.run_start_time                                      AS run_start_time,

    /* дата последнего изменения — по scheduler */
    TO_DATE(s.last_saved, 'MM/DD/YYYY/HH24/MI')           AS last_update_time,

    /* плановое время запуска */
    TO_CHAR(
        TO_DATE(s.start_time, 'MM/DD/YYYY/HH24/MI'),
        'HH24:MI'
    )                                                     AS wf_sched_time,

    CASE
        WHEN t.workflow_run_id IS NULL THEN 'NOT STARTED'
        WHEN t.run_end_time IS NULL THEN 'RUNNING'
        WHEN NVL(t.run_err_code,0) <> 0 THEN 'ERROR/WARNING'
        ELSE 'SUCCESS'
    END                                                   AS wf_status

FROM wf_today t
LEFT JOIN RB_REP.OPB_SCHEDULER s
    ON s.scheduler_id = t.scheduler_id

ORDER BY
    t.run_start_time DESC NULLS LAST,
    LOWER(t.workflow_name);