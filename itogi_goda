/*+ parallel(8) */
WITH base AS (
  SELECT 
    ha.iin_bin                          AS iin,
    trunc(ha.exec_date, 'mm')          AS mnth,
    ha.amount_sum_nat                  AS amt
  FROM dds.rs_ds_anl_halfentry_fl ha
  JOIN dds.rs_pd_payment_fl pd
    ON ha.rs_ds_oper_source_id = pd.parent_processid
   AND ha.rs_ds_oper_njrn       = pd.parent_process_njrn
  JOIN dds.rs_ds_contract_scd_s ds
    ON ha.rs_ds_contract_id = ds.dwh_id
   AND ds.is_actual = 'A'
  JOIN dds.rs_gm_product_h pr
    ON ds.rs_gm_product_id = pr.dwh_id
  -- убрал left join на gm_subject_h, т.к. он не используется в итогах; 
  -- верните, если нужен для фильтрации/вложений
  WHERE ha.date_value >= DATE '2025-01-01'
    AND ha.date_value <  TRUNC(sysdate, 'mm')
    AND pd.date_value >= DATE '2025-01-01'
    AND pd.date_value <  TRUNC(sysdate, 'mm')
    AND ha.incom_fl = 0
    AND ha.nord    = 1
    -- более быстрый эквивалент lower(...) like '%выплата%'
    AND instr(upper(ha.assign), 'ВЫПЛАТ') > 0
    -- условие по close_date как в исходнике
    AND (ds.close_date = ds.end_date OR ds.close_date IS NULL)
),
agg AS (
  SELECT
    iin,
    COUNT(DISTINCT mnth)                AS cnt_mnth,
    ROUND(SUM(amt))                     AS percent_sum,
    ROUND( SUM(amt) / NULLIF(COUNT(DISTINCT mnth),0) ) AS amount_month
  FROM base
  GROUP BY iin
)
SELECT
  /*+ parallel(8) */
  a.iin,
  a.percent_sum,
  a.cnt_mnth,
  a.amount_month,
  'depo_itog_proc'                       AS product_code,
  TRUNC(sysdate)                         AS upload_date,
  /* Собираем JSON через JSON_OBJECT / JSON_ARRAY */
  JSON_OBJECT(
    'en' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE TO_CHAR(a.percent_sum))),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE TO_CHAR(a.amount_month)))
    ),
    'kk' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE TO_CHAR(a.percent_sum))),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE TO_CHAR(a.amount_month)))
    ),
    'ru' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(amountTotal)' VALUE TO_CHAR(a.percent_sum))),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','month'),
                  'replacements' VALUE JSON_OBJECT('%(amountMonth)' VALUE TO_CHAR(a.amount_month)))
    )
  )                                    AS payload
FROM agg a;