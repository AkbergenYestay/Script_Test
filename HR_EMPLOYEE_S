WITH emp AS (
    SELECT gm.DWH_ID,
           gm.IIN_BIN,
           hr.EMPLOYEE_CATEGORY
    FROM dds.GM_SUBJECT_H gm
    JOIN (
        SELECT DISTINCT IIN_BIN, EMPLOYEE_CATEGORY
        FROM dds.HR_EMPLOYEE_S
        WHERE IS_ACTUAL = 'A'
          AND IS_FIRED  = 0
          AND IIN_BIN IS NOT NULL
    ) hr
      ON gm.IIN_BIN = hr.IIN_BIN
    WHERE gm.GM_SYSTEM_CODE = 'W4'
),
base AS (
    -- Дедуп: одна строка на пару (public_id, IIN_BIN)
    SELECT /*+ parallel(4) */
           DISTINCT
           mdmsub.public_id,
           emp.IIN_BIN,
           CASE WHEN emp.EMPLOYEE_CATEGORY = 41 THEN 1 ELSE 0 END AS flag_position
    FROM dds.mdm_subject_l mdml
    JOIN dds.mdm_subject_s mdmsub
      ON mdml.mdm_subject_id = mdmsub.dwh_id
    JOIN emp
      ON mdml.GM_SUBJECT_ID = emp.DWH_ID
    WHERE mdml.DATE_VALUE             = TO_DATE('13.10.2025', 'dd.mm.yyyy')
      AND mdml.eng_source_system_code = 'W4'
      AND mdml.party_main_type_code   = 'ФИЗИЧЕСКОЕ_ЛИЦО'
      AND mdmsub.ENG_ACTIVE           = 1
      AND mdmsub.IS_ACTUAL            = 'A'
      AND mdml.GM_SUBJECT_ID         <> -1
),
cnt AS (
    -- Считаем число public_id на каждый IIN
    SELECT IIN_BIN, COUNT(*) AS flag_iin
    FROM base
    GROUP BY IIN_BIN
)
SELECT
    b.public_id,
    b.flag_position,
    c.flag_iin          AS flag_iin  -- количество public_id на этот IIN
FROM base b
JOIN cnt  c
  ON c.IIN_BIN = b.IIN_BIN;