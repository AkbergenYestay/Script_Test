/* ПАРАМЕТРЫ — подставьте бинды при желании (:d_b, :d_e, :as_of) */
WITH
params AS (
  SELECT
    DATE '2025-07-31' AS d_b,
    DATE '2025-07-31' AS d_e,
    DATE '2025-07-31' AS as_of
  FROM dual
),

/* Справочники — ранняя фильтрация по системе и IIN */
subj AS (
  SELECT /*+ MATERIALIZE */
         dwh_id, iin_bin, longname
  FROM   dds.gm_subject_h
  WHERE  gm_system_code = 'RS'
  AND    iin_bin = '871119350591'
),
acct AS (
  SELECT /*+ MATERIALIZE */
         dwh_id, account_number
  FROM   dds.gl_account_h
  WHERE  gm_system_code = 'RS'
),

/* Активные договорные счета — вместо коррелированного EXISTS */
act_gl AS (
  SELECT /*+ MATERIALIZE */
         l.gl_account_id
  FROM   dds.RS_DS_CONTRACT_ACCOUNT_L l
  JOIN   dds.RS_DS_CONTRACT_H ds
         ON ds.dwh_id = l.RS_DS_CONTRACT_ID
  WHERE  l.is_actual = 'A'
  GROUP  BY l.gl_account_id
),

/* Срез «суточных» платежей на as_of */
pd_pay AS (
  SELECT /*+ MATERIALIZE */
         source_id,
         refer,
         rs_gm_opertype_id
  FROM   dds.RS_PD_PAYMENT_FL, params p
  WHERE  date_value = p.as_of
),
pd_cash AS (
  SELECT /*+ MATERIALIZE */
         source_id,
         refer,
         pd_oprchr_code
  FROM   dds.RS_PD_ORDCASH_FL, params p
  WHERE  date_value = p.as_of
),

/* Последний тип операции по (source_id, incom_fl, nord) на as_of */
oper AS (
  SELECT RS_GL_HALFENTRY_SOURCE_ID,
         RS_GL_HALFENTRY_INCOM_FL,
         RS_GL_HALFENTRY_NORD,
         RS_GM_OPERTYPE_ID
  FROM (
    SELECT
      l.RS_GL_HALFENTRY_SOURCE_ID,
      l.RS_GL_HALFENTRY_INCOM_FL,
      l.RS_GL_HALFENTRY_NORD,
      o.RS_GM_OPERTYPE_ID,
      ROW_NUMBER() OVER (
        PARTITION BY l.RS_GL_HALFENTRY_SOURCE_ID,
                     l.RS_GL_HALFENTRY_INCOM_FL,
                     l.RS_GL_HALFENTRY_NORD
        ORDER BY o.OPER_DATE DESC
      ) AS rn
    FROM   dds.RS_DS_HALFENTRY_OPER_L l
    JOIN   dds.RS_DS_OPER_FL o
           ON  o.SOURCE_ID = l.RS_DS_OPER_SOURCE_ID
           AND o.NJRN      = l.RS_DS_OPER_NJRN
    JOIN   params p
           ON  l.DATE_VALUE = p.as_of
           AND o.DATE_VALUE = p.as_of
  )
  WHERE rn = 1
)

SELECT
  'COLVIR_DEPO'                                     AS system,
  ff.gm_currency_id                                 AS DDEPO_CURRENCY,
  ff.exec_date                                      AS DDEPO_FROMDATE,
  ff.sdok_sum                                       AS oper_sum,
  ff.sdok_sum_nat                                   AS oper_sum_nat,
  COALESCE(pd.refer, cash.refer)                    AS refer,
  ff.source_id                                      AS trn_id,
  TO_CHAR(ac.account_number)                        AS id,
  CASE WHEN ff.incom_fl = 1 THEN 0 ELSE 1 END       AS dohod,
  COALESCE(ff.dscr, ff.doc)                         AS "operation_name",
  g.iin_bin                                         AS iin,
  g.longname                                        AS name,
  dot.longname                                      AS dot_longname,
  sot.longname                                      AS sot_longname,
  pot.longname                                      AS pot_longname
FROM   dds.RS_GL_HALFENTRY_FL ff
JOIN   params p
       ON ff.date_value BETWEEN p.d_b AND p.d_e
/* сузим по субъекту и системе как можно раньше */
JOIN   subj g
       ON g.dwh_id = ff.gm_subject_id
JOIN   acct ac
       ON ac.dwh_id = ff.gl_account_id
/* полусоединение по активным счетам (вместо коррелированного EXISTS) */
JOIN   act_gl ag
       ON ag.gl_account_id = ff.gl_account_id
/* «суточные» левые соединения уже с фиксированной датой */
LEFT JOIN pd_pay  pd
       ON pd.source_id = ff.ord_id
LEFT JOIN pd_cash cash
       ON cash.source_id = ff.ord_id
LEFT JOIN oper
       ON oper.RS_GL_HALFENTRY_SOURCE_ID = ff.source_id
      AND oper.RS_GL_HALFENTRY_INCOM_FL = ff.incom_fl
      AND oper.RS_GL_HALFENTRY_NORD     = ff.nord
LEFT JOIN dds.RS_GM_OPERTYPE_H dot
       ON dot.dwh_id  = oper.RS_GM_OPERTYPE_ID
LEFT JOIN dds.RS_GM_OPERTYPE_H sot
       ON sot.dwh_code = cash.pd_oprchr_code
LEFT JOIN dds.RS_GM_OPERTYPE_H pot
       ON pot.dwh_id  = pd.RS_GM_OPERTYPE_ID;