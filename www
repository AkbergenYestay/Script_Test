WITH base AS (
  /* один проход по тяжёлой таблице */
  SELECT /*+ PARALLEL(tr,8) */
    tr.ret_ref_number,
    tr.local_sum,
    tr.trans_date,
    tr.date_value,
    tr.source_number,
    tr.request_category,
    tr.w4_trans_type_id,
    tr.target_is_on_us,
    tr.posting_status,
    trg.iin_bin AS trg_iin,
    gms.iin_bin AS gms_iin,
    gms.is_actual AS gms_actual,
    LOWER(a.product_name) AS product_name,
    th.ccat AS client_ccat
  FROM dds.w4_transaction_fl tr
  LEFT JOIN dds.gm_subject_h trg  ON trg.dwh_id = tr.target_gm_subject_id
  LEFT JOIN dds.w4_gm_subject_s gms ON gms.dwh_id = tr.target_gm_subject_id
  LEFT JOIN dds.w4_client_type_h th ON th.dwh_id = gms.w4_client_type_id
  LEFT JOIN dds.w4_product_h a ON a.dwh_id = tr.w4_product_id
  WHERE tr.date_value >= DATE '2025-12-01'
    AND tr.date_value <  DATE '2025-12-10' + 5        -- если нужно +5 дней
    AND tr.trans_date >= DATE '2025-12-01'            -- избегаем TRUNC
    AND tr.trans_date <  DATE '2025-12-10'
    AND tr.source_number IN ('98301388','98301383','98301382','98301384','98301385')
    AND tr.w4_trans_type_id IN (9322,9350,10030)
    AND tr.target_is_on_us = 'Y'
    /* ограничение по iin ускоряет выборку — оставил как у вас */
    AND (trg.iin_bin = '070311651047' OR gms.iin_bin = '070311651047')
),

retur AS (
  /* возвраты — берём из base (без отдельного прохода по таблице транзакций) */
  SELECT DISTINCT
    COALESCE(trg_iin, gms_iin) AS iin,
    ret_ref_number
  FROM base
  WHERE request_category IN ('R','J')
),

norm AS (
  SELECT DISTINCT
    gms_iin AS iin,
    ret_ref_number,
    local_sum,
    trans_date,
    posting_status
  FROM base
  WHERE client_ccat = 'P'
    AND product_name NOT LIKE '%bus%'
    AND product_name NOT LIKE '%corp%'
    /* если важно, требуйте posting_status = 'P' — сейчас просто передаём колонку */
),

market AS (
  /* транзакции без возвратов */
  SELECT n.iin, n.ret_ref_number AS contr, n.local_sum AS amt
  FROM norm n
  WHERE NOT EXISTS (
    SELECT 1 FROM retur r WHERE r.ret_ref_number = n.ret_ref_number
  )

  UNION ALL

  /* контракты halykmarket */
  SELECT cl.iin_bin AS iin, c.contract_number AS contr, c.contract_sum_nat AS amt
  FROM dds.rs_cr_contract_scd_s c
  JOIN dds.gm_subject_h cl ON c.gm_subject_id = cl.dwh_id
  WHERE c.open_date >= DATE '2025-12-01'
    AND c.open_date <  DATE '2025-12-10'
    AND LOWER(NVL(c.partner_name,'')) = 'halykmarket'
    AND c.is_actual = 'A'
    AND c.status_code NOT IN ('REFUSED')
    AND cl.iin_bin = '070311651047'
),

fnl AS (
  SELECT
    m.iin,
    COUNT(DISTINCT m.contr) AS cnt,
    ROUND(SUM(m.amt)) AS amt
  FROM market m
  WHERE m.iin IS NOT NULL
  GROUP BY m.iin
)

SELECT /*+ PARALLEL(8) */
  f.iin,
  f.cnt,
  f.amt,
  'itogi_goda_market' AS product_code,

  -- JSON оставлен в исходном виде (ваш оригинальный синтаксис)
  JSON_OBJECT(
    'en' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(total)' VALUE f.amt)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','purchases'),
                  'replacements' VALUE JSON_OBJECT('%(purchases)' VALUE f.cnt))
    ),
    'kk' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(total)' VALUE f.amt)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','purchases'),
                  'replacements' VALUE JSON_OBJECT('%(purchases)' VALUE f.cnt))
    ),
    'ru' VALUE JSON_ARRAY(
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','total'),
                  'replacements' VALUE JSON_OBJECT('%(total)' VALUE f.amt)),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','currency'),
                  'replacements' VALUE JSON_OBJECT('%(currency)' VALUE 'KZT')),
      JSON_OBJECT('path' VALUE JSON_ARRAY('values','purchases'),
                  'replacements' VALUE JSON_OBJECT('%(purchases)' VALUE f.cnt))
    )
  RETURNING VARCHAR2   -- <-- как в вашем оригинале: оставил тип возвращаемого значения
  ) AS payload
FROM fnl f
WHERE f.amt > 100
  AND f.cnt > 0;