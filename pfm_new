    with all_tr as (
        select /*+ parallel(4) */
            iin_bin iin, 
            ret_ref_number, 
            ACQ_REF_NUMBER, 
            local_sum, 
          --  sic_code, 
            case
            when sic_code in ('8398') then 'Благотворительность'
            when sic_code in ('1490', '9223', '9211', '9311', '9399', '8111', '9222', '7276') then 'Госуслуги'
            when sic_code in ('0743', '0744', '0742', '5995') then 'Домашние животные'
            when sic_code in ('0061', '0062', '0035', '0052', '1384', '1391', '5911', '5991', '7232', '8044', '8071', '8734', '8082', '8011', '8021', '8031', '7298', '5975', '5977', '5912', '8042', '8043', '8049', '8050', '8062', '8099', '8041', '4119', '7280', '5698', '5122', '0043', '0053', '1472', '5913', '7231', '7230', '7297', '5976') then 'Здоровье и уход'
            when sic_code in ('1399', '1402', '0024', '0025', '0074', '5812', '5813', '1347', '1349', '1339', '1340', '1341', '2002', '5462', '1428', '5811', '5814') then 'Кафе и рестораны'
            when sic_code in ('2501', '2502', '4811', '4818', '1385', '1386', '1387', '1388', '0072', '1455', '1467', '4813', '0067', '1345', '1337', '1332', '4814', '4821', '4899', '4900', '1731', '4812', '1420', '2503', '4786', '4817', '4819', '0006', '1481') then 'Коммунальные услуги и связь'
            when sic_code in ('5712', '5200') then 'Мебель'
            when sic_code in ('1477', '8220', '8299', '8211', '8241', '8244', '8249', '8351', '5192') then 'Образование'
            when sic_code in ('1439', '2111', '5335', '0014', '0016', '0018', '1383', '2385', '2386', '2387', '2388', '0075', '1370', '1371', '1436', '1447', '1459', '1488', '5662', '1392', '1394', '1355', '1357', '7296', '1358', '2360', '1351', '5944', '2338', '2340', '5948', '5611', '5631', '5641', '5651', '5661', '5681', '5691', '5699', '5139', '5621', '5655', '5697', '5137', '1406', '2102', '5338', '0008', '0015', '0017', '0019', '0028', '1450', '1452', '1468', '5314', '5663') then 'Одежда, обувь, аксессуары'
            when sic_code in ('6536', '6538', '6537', '6012', '1000') then 'Переводы'
            when sic_code in ('1005') then 'Погашение кредита'
            when sic_code in ('5947', '1437', '0030') then 'Подарки'
            when sic_code in ('1407', '1419', '1496', '1500', '0001', '0003', '0005', '0033', '3809', '3813', '3814', '0056', '0057', '0058', '0059', '1389', '1393', '3822', '0073', '1365', '1372', '1374', '2414', '4014', '0076', '0077', '0078', '0079', '3824', '3825', '3826', '3827', '3297', '3174', '3791', '3248', '3247', '3245', '3246', '3569', '3557', '3566', '3576', '3578', '3589', '3594', '3597', '3213', '3226', '1482', '1492', '1494', '1497', '3156', '3183', '3211', '3521', '3532', '3556', '3560', '3746', '3782', '3784', '3785', '3786', '3788', '3789', '3790', '3794', '3795', '3796', '3798', '3799', '7014', '3559', '3547', '3604', '3606', '3608', '3610', '3019', '3613', '3062', '3296', '3834', '3807', '3810', '3815', '3817', '7010', '3618', '3619', '3621', '3627', '3630', '3801', '3802', '3803', '3805', '0064', '0065', '0066', '0070', '3531', '3180', '3167', '3819', '3820', '3821', '3835', '3840', '3836', '3300', '3301', '3177', '3684', '3687', '3689', '3591', '3598', '3612', '3623', '3634', '3637', '3640', '3643', '3647', '3649', '3536', '3540', '3543', '3548', '3512', '3516', '3520', '3524', '3527', '3530', '3263', '3280', '3285', '3292', '3295', '3196', '3203', '3215', '3218', '3221', '3229', '3234', '3239', '3243', '3117', '3125', '3129', '3137', '3143', '3151', '3161', '3171', '3178', '3182', '3186', '3728', '3732', '3735', '3080', '3070', '3303', '3308', '7012', '7033', '3699', '3700', '3702', '3703', '3704', '3706', '3707', '3710', '3711', '3714', '3715', '3716', '3718', '3719', '3721', '3722', '3723', '3724', '3725', '3653', '3654', '3656', '3657', '3659', '3660', '3661', '3664', '3665', '3668', '3670', '3672', '3673', '3675', '3677', '3678', '3680', '3681', '3683', '3685', '3686', '3652', '3688', '3690', '3691', '3592', '3593', '3595', '3599', '3603', '3615', '3622', '3625', '3629', '3633', '3635', '3636', '3638', '3639', '3641', '3642', '3644', '3645', '3646', '3648', '3590', '3650', '3651', '3537', '3538', '3541', '3542', '3544', '3545', '3549', '3511', '3513', '9951', '3515', '3517', '3518', '3519', '3522', '3523', '3525', '3526', '3528', '3529', '3533', '3534', '3261', '3262', '3266', '3267', '3282', '3284', '3286', '3287', '3293', '3294', '3298', '3299', '3259', '3192', '3193', '3197', '3200', '3204', '3212', '3216', '3217', '3219', '3220', '3222', '3223', '3228', '3231', '3233', '3235', '3238', '3240', '3241', '3242', '3251', '3252', '3191', '1359', '3828', '3816', '1344', '1348', '1352', '2348', '3118', '3126', '3127', '3130', '3133', '3135', '3138', '3144', '3145', '3146', '3154', '3159', '3164', '3165', '3170', '3172', '3175', '3176', '3112', '3181', '3184', '3185', '3187', '3190', '3729', '3730', '3731', '3733', '3734', '3736', '3737', '3738', '3741', '3742', '3743', '4411', '3727', '3694', '3696', '3697', '3253', '3055', '3056', '3058', '3060', '3063', '3065', '3071', '3075', '3077', '3078', '3081', '3083', '3084', '3086', '3087', '3088', '3092', '3094', '3096', '3099', '3102', '3103', '3106', '3111', '3054', '3022', '3023', '3024', '3026', '3027', '3030', '3031', '3033', '3035', '3036', '3037', '3039', '3040', '3042', '3043', '3044', '3046', '3047', '3049', '3050', '3052', '3053', '3020', '3000', '3002', '3004', '3005', '3007', '3008', '3010', '3011', '3013', '3014', '3016', '3018', '3302', '3837', '3838', '3832', '3069', '3616', '3745', '3998', '4733', '3550', '3552', '3553', '3562', '3563', '3568', '3570', '3573', '3574', '3575', '3579', '3581', '3535', '3584', '3586', '3587', '3501', '3502', '3504', '3506', '3507', '3509', '3510', '3097', '3254', '3555', '3564', '3582', '3624', '3662', '3667', '3669', '3679', '3682', '3708', '3758', '3759', '3760', '3762', '3763', '3764', '3766', '3767', '3064', '3098', '3539', '3631', '3748', '3749', '3750', '3752', '3753', '3755', '3756', '3757', '1343', '1335', '3769', '3770', '3772', '3773', '3774', '3776', '3777', '3778', '3780', '4723', '3740', '3067', '3829', '3830', '3831', '4722', '3551', '3739', '3744', '3693', '3695', '3256', '3057', '3061', '3066', '3076', '3082', '3085', '3089', '3095', '3100', '3110', '3021', '3025', '3029', '3032', '3034', '3038', '3041', '3045', '3048', '3051', '3001', '3006', '3009', '3012', '3015', '3017', '3558', '3565', '3572', '3577', '3583', '3585', '3588', '3503', '3505', '3508', '3206', '3546', '3620', '3628', '3676', '3712', '3761', '3765', '3768', '3514', '3747', '3751', '3754', '3771', '3775', '3779', '3781', '3168', '3028', '1398', '1426', '1499', '1501', '3818', '0004', '3808', '3812', '3823', '3793', '3260', '3567', '3571', '3580', '3596', '3236', '1446', '1448', '1458', '1476', '1478', '1485', '1491', '1495', '1498', '3131', '3554', '3561', '3632', '3783', '3787', '3792', '3797', '3003', '3602', '3605', '3607', '3609', '3611', '3059', '3614', '3811', '3617', '3626', '3800', '3804', '3806', '3188', '3079', '3839', '7011', '3698', '3701', '3705', '3709', '3713', '3717', '3720', '3692', '3726', '3655', '3658', '3663', '3666', '3671', '3674') then 'Путешествия'
            when sic_code in ('1429', '0027', '0029', '0042', '0054', '1382', '8411', '8412', '0068', '0069', '7993', '7996', '7998', '5970', '5733', '5734', '5735', '1360', '7990', '5933', '5935', '5942', '7829', '7832', '7841', '7922', '7929', '7932', '7941', '7991', '7992', '5815', '5816', '5817', '5818', '7802', '1338', '5945', '7911', '7933', '5946', '1432', '1456', '1470', '1483', '7989', '7994') then 'Развлечение'
            when sic_code in ('1404', '1421', '1423', '1427', '1526', '2425', '2491', '2526', '7013', '0011', '0031', '0051', '5936', '0063', '1378', '1381', '0071', '9754', '1442', '1444', '1453', '1471', '1473', '1479', '1484', '2131', '2215', '2398', '2399', '2412', '2433', '2454', '2481', '2489', '2722', '2734', '2941', '2961', '2995', '3600', '3601', '5313', '5939', '5952', '5961', '6513', '7015', '2401', '5333', '8651', '5723', '7995', '7997', '7311', '7321', '7332', '7338', '7339', '7342', '7361', '7375', '7392', '7393', '7394', '7399', '7299', '7211', '7216', '7217', '7221', '7251', '7261', '7273', '7277', '7278', '5964', '5965', '5966', '5968', '5969', '5972', '5973', '5978', '5993', '5994', '5998', '5962', '5931', '2912', '8666', '1346', '2346', '5932', '5937', '5943', '9402', '8641', '8661', '8699', '8911', '8931', '8999', '4111', '4225', '4468', '0780', '2741', '2842', '7631', '5262', '9406', '7295', '8912', '7777', '9400', '3833', '7800', '7801', '5398', '9405', '2829', '1333', '9701', '9950', '5949', '5960', '5131', '5169', '5172', '5193', '5198', '5199', '5309', '5311', '5331', '5399', '4815', '5044', '5047', '5051', '5085', '5094', '5099', '1002', '1008', '1111', '0763', '2791', '7699', '9702', '5950', '7322', '4458', '3169', '5261', '5310', '5046', '5111', '1430', '2231', '2494', '0010', '0034', '0036', '0038', '0041', '1435', '1438', '1443', '1474', '1487', '2133', '2310', '2411', '2432', '2456', '2483', '2541', '2732', '2946', '2994', '5312', '2530', '5715', '7333', '7349', '7395', '7210', '5963', '5967', '5971', '5992', '5999', '1001', '1004') then 'Разное'
            when sic_code in ('1405', '2419', '2453', '2511', '2522', '2543', '2942', '0060', '0009', '0020', '0037', '0055', '1502', '1503', '1504', '1530', '2434', '1457', '1463', '1480', '5955', '5957', '5959', '5722', '1531', '2520', '2531', '2548', '5001', '5002', '1520', '1711', '1740', '1750', '1771', '1799', '7622', '7623', '7641', '7692', '2422', '5719', '5531', '5714', '5718', '5211', '5231', '5251', '5271', '5039', '5074', '1761', '7629', '5713', '5021', '2420', '2437', '2490', '2521', '0021', '1460', '1462', '1466', '5951', '5953', '5956', '5958') then 'Ремонт'
            when sic_code in ('6010', '6011') then 'Снятие наличных'
            when sic_code in ('1416', '1449', '7988', '1356', '7032', '5996', '5940', '5941', '0026', '1493', '7987', '7999') then 'Спорт'
            when sic_code in ('6300', '6381', '6399') then 'Страхование'
            when sic_code in ('1401', '1409', '1411', '1413', '1414', '1418', '1434', '2097', '0012', '1379', '1363', '1366', '1368', '1373', '1465', '1390', '1396', '5921', '1362', '1350', '1353', '1354', '9401', '9751', '1342', '1336', '5300', '5422', '5441', '5451', '5499', '5411', '1400', '1403', '1410', '1412', '1415', '1417', '1422', '2013', '0013', '9753', '1395', '1397') then 'Супермаркеты и продукты'
            when sic_code in ('0007', '0022', '1475', '1486', '5350', '7372', '5997', '1361', '4816', '5045', '5065', '5072', '1408', '1424', '0023', '1441', '7379', '5732') then 'Техника и электроника'
            when sic_code in ('1425', '1431', '1521', '1524', '1528', '1529', '2524', '2528', '0002', '0039', '0040', '1376', '1380', '2376', '2380', '1364', '1367', '1369', '1375', '2014', '2364', '2367', '2369', '2397', '1433', '1440', '1451', '1469', '4012', '4013', '4133', '4783', '7539', '3068', '3388', '5543', '3386', '3391', '3395', '3405', '3414', '3425', '3430', '3433', '3385', '3351', '3355', '3361', '3368', '3376', '7511', '7512', '7513', '7523', '7531', '7534', '7538', '7542', '5983', '3438', '3387', '3389', '3390', '3393', '3394', '3396', '3398', '3400', '3409', '3412', '3420', '3421', '3423', '3427', '3428', '3429', '3431', '3432', '3434', '3435', '3436', '3437', '3352', '3353', '3354', '3359', '3360', '3362', '3364', '3366', '3370', '3381', '9752', '8675', '4011', '4121', '4131', '4215', '4511', '5552', '3439', '3441', '9700', '5545', '1334', '3090', '3115', '3136', '3148', '3357', '5533', '5541', '5542', '5561', '5571', '5592', '5599', '5521', '5511', '4784', '4789', '5013', '4582', '4001', '4002', '4003', '4004', '0050', '4112', '4214', '4457', '3132', '3380', '5532', '5551', '5598', '1522', '1525', '1527', '2523', '2525', '2527', '2529', '0032', '1464', '3374', '4132', '4785', '5544', '3072', '7549', '7519', '7535') then 'Транспорт'
            when sic_code in ('6555', '6535', '1461', '6310', '6529', '6531', '6532', '6533', '6541', '6542', '6543', '6539', '6026', '6028', '6051', '6023', '6022', '2461', '0044', '0046', '0048', '6540', '4829', '0045', '0047', '0049', '1445', '1454', '1489', '6050', '6530', '6534', '6025', '6211', '1003') then 'Финансовые услуги'
                        else 'Разное' end as mcg_name
        from dds.w4_transaction_fl tr
     inner join dds.w4_gm_subject_s gms  on tr.target_gm_subject_id = gms.dwh_id and GMS.IS_ACTUAL = 'A' AND GMS.AMND_STATE = 'A' AND GMS.FIZ_FL = '1'
     inner join dds.w4_client_type_h th  on gms.w4_client_type_id=th.dwh_id 
    --    inner join dds.gm_subject_h gms  on tr.target_gm_subject_id = gms.dwh_id
        left join dds.w4_product_h a  on a.dwh_id = tr.w4_product_id
        left join dds.w4_sic_h sic  on sic.dwh_id=tr.w4_sic_id 

        where 1 = 1
        and tr.date_value >= trunc(add_months(sysdate, -1), 'mm')
        and tr.date_value < trunc(sysdate, 'mm') + 5
        and trunc(tr.trans_date) >= trunc(add_months(sysdate, -1), 'mm')
        and trunc(tr.trans_date) < trunc(sysdate, 'mm')
        and tr.w4_trans_type_id in (9322, 9350, 10030)
        and tr.device_type != 'HOMEBANK'
        and th.ccat='P'
        and lower(a.product_name) not like '%bus%'
        and lower(a.product_name) not like '%corp%'
        and tr.target_is_on_us = 'Y'
        and tr.service_class = 'T'
        and tr.request_category in ('P')
        and tr.direction = -1
        and iin_bin is not null
   ),
    qr as (
        select /*+ parallel(4) */
            iin_bin iin,
            ret_ref_number, 
            direction, 
            local_sum*-1 local_sum
        from dds.w4_transaction_fl tr
        inner join dds.gm_subject_h targsubj on targsubj.dwh_id = tr.target_gm_subject_id
        where 1 = 1
        and tr.date_value >= trunc(add_months(sysdate, -1), 'mm')
        and tr.date_value < trunc(sysdate, 'mm') + 5
        and trunc(tr.trans_date) >= trunc(add_months(sysdate, -1), 'mm')
        and trunc(tr.trans_date) < trunc(sysdate, 'mm')
        and tr.W4_TRANS_TYPE_ID = 9328
        and tr.target_is_on_us = 'Y'
        and tr.source_is_on_us = 'Y'
        and tr.direction = 1
        and tr.service_class = 'T'
        and ret_ref_number is not null
    ),
    bvu_card as (
        select /*+ parallel(4) */
            iin_bin iin,
            acq_ref_number, 
            direction, 
            local_sum*-1 local_sum
        from dds.w4_transaction_fl tr
        inner join dds.gm_subject_h targsubj on targsubj.dwh_id = tr.target_gm_subject_id
        where 1 = 1
        and tr.date_value >= trunc(add_months(sysdate, -1), 'mm')
        and tr.date_value < trunc(sysdate, 'mm') + 5
        and trunc(tr.trans_date) >= trunc(add_months(sysdate, -1), 'mm')
        and trunc(tr.trans_date) < trunc(sysdate, 'mm')
        and tr.W4_TRANS_TYPE_ID = 9328
        and tr.target_is_on_us = 'Y'
        and tr.source_is_on_us = 'N'
        and tr.direction = 1
        and tr.service_class = 'T'
        and acq_ref_number is not null
    ),
    token as (
        select /*+ parallel(4) */
            iin_bin iin,
            ret_ref_number, 
            direction, 
            local_sum
        from dds.w4_transaction_fl tr
        inner join dds.gm_subject_h targsubj on targsubj.dwh_id = tr.target_gm_subject_id
        where 1 = 1
        and  tr.date_value >= trunc(add_months(sysdate, -1), 'mm')
        and tr.date_value < trunc(sysdate, 'mm') + 5
        and trunc(tr.trans_date) >= trunc(add_months(sysdate, -1), 'mm')
        and trunc(tr.trans_date) < trunc(sysdate, 'mm')
        and tr.w4_trans_type_id in (9322, 9350, 10030)
        and tr.target_is_on_us = 'Y'
        and request_category in ('R', 'J')
        and tr.source_is_on_us = 'Y'
        and direction = -1
        and ret_ref_number is not null
    ),
    token_bvu as (
        select /*+ parallel(4) */
            iin_bin iin,
            ACQ_REF_NUMBER, 
            direction,  
            local_sum
        from dds.w4_transaction_fl tr
        inner join dds.gm_subject_h targsubj on targsubj.dwh_id = tr.target_gm_subject_id
        where 1 = 1
        and  tr.date_value >= trunc(add_months(sysdate, -1), 'mm')
        and tr.date_value < trunc(sysdate, 'mm')+5
        and trunc(tr.trans_date) >= trunc(add_months(sysdate, -1), 'mm')
        and trunc(tr.trans_date) < trunc(sysdate, 'mm')
        and tr.w4_trans_type_id in (9322, 9350, 10030)
        and tr.target_is_on_us = 'Y'
        and request_category in ('R', 'J')
        and tr.source_is_on_us = 'N'
        and direction = -1
        and ACQ_REF_NUMBER is not null
    ),
    
    category_data as
    (select
        iin, 
        mcg_name,
        row_number() over (partition by iin order by CURR_AMT_SUM desc) as rank_num, 
        CURR_AMT_SUM amount,
        CURR_TR_CNT transaction_cnt
        from(select
                    tr.IIN,
                    mcg_name,
                    sum(nvl(tr.local_sum, 0) + nvl(qr.local_sum, 0) + nvl(bvu_card.local_sum, 0) + nvl(token.local_sum, 0) + nvl(token_bvu.local_sum, 0)) AS CURR_AMT_SUM,
                    count (distinct coalesce(tr.ret_ref_number, tr.acq_ref_number) ) AS CURR_TR_CNT
            from all_tr tr
            left join qr on tr.ret_ref_number = qr.ret_ref_number and tr.iin = qr.iin
            left join bvu_card on bvu_card.acq_ref_number = tr.acq_ref_number and tr.iin = bvu_card.iin
            left join token on token.ret_ref_number = tr.ret_ref_number and tr.iin = token.iin
            left join token_bvu on token_bvu.acq_ref_number = tr.acq_ref_number and tr.iin = token_bvu.iin
            where 1=1
            and mcg_name not in ('Снятие наличных', 'Финансовые услуги', 'Переводы')
            group by tr.IIN, mcg_name
            )mcg_sum 
        where CURR_TR_CNT > 0
	and CURR_AMT_SUM >= 10
    ),
    mcg_cnt as (
        select iin, max(rank_num)
        from
        category_data
        group by iin
        having max(rank_num) >2)
    
select /*+ parallel(4) */
            cd.iin, 
         --   trunc(sysdate) as period_start,
         --  trunc(sysdate)+14 as period_end,
           tstzrange(date_trunc('day',now())::timestamp - interval '5 hours', date_trunc('day',now()+interval '13 day')::timestamp + interval '19 hours','[)') as period 
          -- ["2025-09-08 19:00:00+05","2025-09-22 19:00:00+05")

            case when mcg_name = 'Благотворительность' then 'top3mcg_m_charity'
                    when mcg_name = 'Госуслуги' then 'top3mcg_m_govtech'
                    when mcg_name = 'Домашние животные' then 'top3mcg_m_pet'
                    when mcg_name = 'Здоровье и уход' then 'top3mcg_m_health'
                    when mcg_name = 'Кафе и рестораны' then 'top3mcg_m_rest'
                    when mcg_name = 'Коммунальные услуги и связь' then 'top3mcg_m_utility'
                    when mcg_name = 'Мебель' then 'top3mcg_m_furnit'
                    when mcg_name = 'Образование' then 'top3mcg_m_educ'
                    when mcg_name = 'Одежда, обувь, аксессуары' then 'top3mcg_m_fashion'
                    when mcg_name = 'Переводы' then 'top3mcg_m_transf'
                    when mcg_name = 'Подарки' then 'top3mcg_m_gifts'
                    when mcg_name = 'Путешествия' then 'top3mcg_m_travel'
                    when mcg_name = 'Развлечение' then 'top3mcg_m_entert'
                    when mcg_name = 'Разное' then 'top3mcg_m_other'
                    when mcg_name = 'Ремонт' then 'top3mcg_m_constr'
                    when mcg_name = 'Спорт' then 'top3mcg_m_sport'
                    when mcg_name = 'Страхование' then 'top3mcg_m_insur' 
                    when mcg_name = 'Супермаркеты и продукты' then 'top3mcg_m_market'
                    when mcg_name = 'Техника и электроника' then 'top3mcg_m_electr'
                    when mcg_name = 'Транспорт' then 'top3mcg_m_transport'
                    when mcg_name = 'Финансовые услуги' then 'top3mcg_m_fin'
            end as product_code,
            case when rank_num = 1 then 10
                    when rank_num = 2 then 20
                    when rank_num = 3 then 30
            end as priority,
            trunc(sysdate, 'mm')-1 as snapshot_date,
            'month' as period_type,
            amount,
            transaction_cnt,
           trunc(sysdate) as upload_date
    from category_data cd
    inner join mcg_cnt mc on cd.iin = mc.iin
    where rank_num <= 3
