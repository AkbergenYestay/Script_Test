INSERT INTO double_id (id)
WITH dupe_keys AS (
    SELECT
        user_id,
        income,
        additional_id_1,
        additional_id_2,
        operation_date::date AS operation_dt,
        posting_date::date   AS posting_dt
    FROM dm.operations
    WHERE operation_date >= DATE '2025-12-26'
      AND operation_date <  DATE '2025-12-27'
    GROUP BY
        user_id, income, additional_id_1, additional_id_2,
        operation_date::date, posting_date::date
    HAVING COUNT(*) > 1
)
SELECT o.id
FROM dm.operations o
JOIN dupe_keys k
  ON k.user_id = o.user_id
 AND k.income = o.income
 AND k.additional_id_1 IS NOT DISTINCT FROM o.additional_id_1
 AND k.additional_id_2 IS NOT DISTINCT FROM o.additional_id_2
 AND k.operation_dt = o.operation_date::date
 AND k.posting_dt   = o.posting_date::date
WHERE o.operation_date >= DATE '2025-12-26'
  AND o.operation_date <  DATE '2025-12-27';


INSERT INTO double_id (id)
WITH ranked AS (
    SELECT
        o.*,
        ROW_NUMBER() OVER (
            PARTITION BY
                user_id, income, additional_id_1, additional_id_2,
                operation_date::date, posting_date::date
            ORDER BY id
        ) AS rn
    FROM dm.operations o
    WHERE operation_date >= DATE '2025-12-26'
      AND operation_date <  DATE '2025-12-27'
)
SELECT id
FROM ranked
WHERE rn > 1;