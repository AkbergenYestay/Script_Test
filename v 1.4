WITH rc AS (
    SELECT 'Part Advice' AS displ_col, 'A' AS data_col FROM dual
    UNION ALL SELECT 'Adjustment', 'J' FROM dual
    UNION ALL SELECT 'Request', 'Q' FROM dual
    UNION ALL SELECT 'Reversal', 'R' FROM dual
    UNION ALL SELECT 'Void', 'V' FROM dual
    UNION ALL SELECT 'Void Request', 'v' FROM dual
),
filtered_account AS (
    SELECT *
    FROM dds.w4_account_s
    WHERE oper_date_year = 2025
      AND oper_date_month = 7
      AND oper_date_day = 23
),
filtered_entry AS (
    SELECT *
    FROM dds.w4_account_entry_fl
    WHERE oper_date_year = 2025
      AND oper_date_month = 7
      AND oper_date_day = 23
),
filtered_transaction AS (
    SELECT *
    FROM dds.w4_transaction_fl
    WHERE oper_date_year = 2025
      AND oper_date_month = 7
      AND oper_date_day = 23
),
filtered_account_ma AS (
    SELECT *
    FROM dds.w4_account_s
    WHERE oper_date_year = 2025
      AND oper_date_month = 7
      AND oper_date_day = 23
)
SELECT *
FROM (
    SELECT 
        entry.id AS entry_id,
        entry.posting_date,
        entry.contract_for AS card_id,
        NVL(doc.trans_date, transaction.posting_date) AS trans_date,
        doc.request_category,
        CASE 
            WHEN transaction.service_class = 'I' THEN 0
            ELSE NVL(
                SIGN(entry.amount) * ABS(
                    CASE 
                        WHEN doc.request_category = 'J' 
                             AND transaction.service_class = 'T' 
                             THEN transaction.trans_amount
                        ELSE doc.trans_amount
                    END
                ),
                entry.amount
            )
        END AS trans_amount,
        CASE 
            WHEN transaction.service_class = 'u' THEN acc_curr.name
            ELSE NVL(tc.name, doc.trans_curr)
        END AS trans_curr,
        entry.fee_amount AS fee_amount,
        entry.amount AS acc_amount,
        0 AS end_balance,
        NVL(acc_curr.name, account.curr) AS acc_curr,
        SUBSTR(
            NVL(trans_subtype.name, transaction.trans_code) || ' ' || rc.displ_col,
            1, 32
        ) AS tr_type,
        doc.trans_country,
        doc.trans_city,
        doc.trans_details,
        doc.sic_code AS mcc,
        doc.auth_code,
        doc.ret_ref_number,
        doc.source_reg_num,
        ma.account_name,
        ma.code,
        transaction.service_class,
        transaction.posting_db_date,
        CASE
            WHEN (doc.add_info LIKE '%POI_AMOUNT%' AND doc.add_info LIKE '%POI_CURR%')
                 OR (doc.add_info LIKE '%DCC_IND=Y%') THEN 'Y'
            ELSE 'N'
        END AS dcc
    FROM dds.w4_contract_s acnt_contract
    JOIN filtered_account account 
        ON account.acnt_contract__oid = acnt_contract.id
    JOIN dds.w4_account_type_h account_type_ 
        ON account_type_.id = account.account_type
    JOIN filtered_entry entry 
        ON entry.account_id = account.id
    JOIN filtered_transaction transaction 
        ON transaction.id = entry.transaction_id
    LEFT JOIN dds.w4_transaction_fl doc 
        ON doc.id = transaction.doc_id
    LEFT JOIN dds.gm_currency_s acc_curr 
        ON acc_curr.code = account.curr 
        AND acc_curr.gm_system_code = 'W4'
    LEFT JOIN dds.gm_currency_s tc 
        ON tc.code = doc.trans_curr 
        AND tc.gm_system_code = 'W4'
    LEFT JOIN dds.w4_transaction_fl trans_subtype 
        ON trans_subtype.id = transaction.trans_subtype
    LEFT JOIN rc 
        ON rc.data_col = transaction.request_cat
    LEFT JOIN filtered_account_ma ma 
        ON transaction.target_account = ma.id
    WHERE 
        (transaction.service_class NOT IN ('L', 'U') 
            OR (transaction.service_class = 'u' 
                AND transaction.trans_code LIKE 'uP%' 
                AND ma.account_name LIKE 'Cl Unpaid%'))
        AND NOT (transaction.service_class IN ('d', 'D') 
                 AND transaction.trans_code <> 'D+')
        AND CASE 
                WHEN transaction.service_class = 'D' THEN 'P' 
                ELSE account.code 
            END = account.code
        AND (account.is_am_available = 'Y' 
             OR account.code LIKE 'P%' 
             OR account.code = 'F3')
        AND (account_type_.group_name <> 'TECHNICAL' 
             OR (account_type_.group_name = 'TECHNICAL' 
                 AND account.code = 'P7'))
) t
WHERE 
    (source_reg_num IS NULL 
        OR (UPPER(source_reg_num) NOT LIKE 'WF_ARST%' 
            AND UPPER(source_reg_num) NOT LIKE 'K2SL%'))
    AND (trans_details IS NULL 
        OR UPPER(trans_details) NOT LIKE 'WF_ARST%')
    AND NOT (request_category <> 'R' 
             AND service_class = 'A' 
             AND (code LIKE 'INST%' 
                  OR code IN ('L11', 'L12')))
FETCH FIRST 10 ROWS ONLY;